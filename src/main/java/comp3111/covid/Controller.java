package comp3111.covid;

import javafx.beans.property.SimpleObjectProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.event.Event;
import javafx.fxml.FXML;
import javafx.scene.chart.LineChart;
import javafx.scene.chart.XYChart;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;

import java.time.LocalDate;
import java.util.*;

/**
 * Building on the sample skeleton for 'ui.fxml' Controller Class generated by SceneBuilder 
 */
public class Controller {
    @FXML
    public ChoiceBox<String> choiceboxCA;

    @FXML
    public ChoiceBox<String> choiceboxTA;
    public Label TAtitle;

    @FXML
    private Tab tabTaskZero;

    @FXML
    private TextField textfieldISO;

    @FXML
    private Button buttonConfirmedDeaths;

    @FXML
    private TextField textfieldDataset;

    @FXML
    private Button buttonRateOfVaccination;

    @FXML
    private Button buttonConfirmedCases;

    @FXML
    private Tab tabReport1;

    @FXML
    private Tab tabReport2;

    @FXML
    private Tab tabReport3;

    @FXML
    private Tab tabApp1;

    @FXML
    private Tab tabApp2;

    @FXML
    private Tab tabApp3;

    @FXML
    private TextArea textAreaConsole;

    @FXML
    private DatePicker datepickerTA;

    @FXML
    private ListView<String> listTA;

    @FXML
    private TableView<Record> tableTA;

    @FXML
    private TableColumn<Record,String> columnCountry;

    @FXML
    private TableColumn<Record, Long> columnCases;

    @FXML
    private TableColumn<Record, Double> columnCases1M;

    @FXML
    private Button generateTA;

    @FXML
    private DatePicker startdateCA;

    @FXML
    private DatePicker enddateCA;

    @FXML
    private Button generateCA;

    @FXML
    private ListView<String> listCA;

    @FXML
    private LineChart<String,Long> chartCA;

    private TableColumn<Record,Long> columnDeath;
    private TableColumn<Record,Double> columnDeath1m;
    private TableColumn<Record,Long> columnFully;
    private TableColumn<Record,Double> columnfull1M;


    /**
     *  Task Zero
     *  To be triggered by the "Confirmed Cases" button on the Task Zero Tab 
     *  
     */
    @FXML
    void doConfirmedCases(ActionEvent event) {
    	String iDataset = textfieldDataset.getText();
    	String iISO = textfieldISO.getText();
    	String oReport = DataAnalysis.getConfirmedCases(iDataset, iISO);
    	textAreaConsole.setText(oReport);
    }

  
    /**
     *  Task Zero
     *  To be triggered by the "Confirmed Deaths" button on the Task Zero Tab
     *  
     */
    @FXML
    void doConfirmedDeaths(ActionEvent event) {
    	String iDataset = textfieldDataset.getText();
    	String iISO = textfieldISO.getText();
    	String oReport = DataAnalysis.getConfirmedDeaths(iDataset, iISO);
    	textAreaConsole.setText(oReport);
    }

  
    /**
     *  Task Zero
     *  To be triggered by the "Rate of Vaccination" button on the Task Zero Tab
     *  
     */
    @FXML
    void doRateOfVaccination(ActionEvent event) {
    	String iDataset = textfieldDataset.getText();
    	String iISO = textfieldISO.getText();
    	String oReport = DataAnalysis.getRateOfVaccination(iDataset, iISO);
    	textAreaConsole.setText(oReport);
    }

    public void opentabA(Event event) throws Exception {
        //Fill the listview
        datepickerTA.setValue(LocalDate.now());
        listTA.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);
        String iDataset = textfieldDataset.getText();
        Countries.read("COVID_Dataset_v1.0.csv");
        for (String temp:Countries.getCountriesString()){
            listTA.getItems().add(temp);
        }
        choiceboxTA.getItems().clear();
        choiceboxTA.getItems().add("A");
        choiceboxTA.getItems().add("B");
        choiceboxTA.getItems().add("C");
        choiceboxTA.getSelectionModel().selectFirst();
        //Setup columns
    }

    public void generateTableA(ActionEvent actionEvent) throws Exception {
        //Check if date is valid
        //Check if selected countries
        ObservableList<String> selectedcountries;
        selectedcountries = listTA.getSelectionModel().getSelectedItems();
        if (selectedcountries.isEmpty()){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Please choose countries");
            errorAlert.showAndWait();
        }
        else if ((datepickerTA.getValue()==null)) {
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Date is empty");
            errorAlert.showAndWait();
        }
        else if (datepickerTA.getValue().isAfter(LocalDate.now())){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Date is after today");
            errorAlert.showAndWait();
        }
        else if (datepickerTA.getValue().isBefore(LocalDate.of(2020,3,1))){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Date is before 2020 - 03 - 01, No data exists");
            errorAlert.showAndWait();
        }else{
            textAreaConsole.setText("");
            textAreaConsole.setText(textAreaConsole.getText()+"Date is:"+datepickerTA.getValue().toString());
            textAreaConsole.setText(textAreaConsole.getText()+"Countries:"+selectedcountries);
            //Generate Table

            ObservableList<Record> records = FXCollections.observableArrayList();
            for (String countryselected: selectedcountries){
                //Setup table
                //System.out.println("Selected :"+countryselected);
                Record temp = new Records("COVID_Dataset_v1.0.csv").getLatestRecord(Countries.toIsoCode(countryselected),datepickerTA.getValue());
                //System.out.println(temp.getCountry()+"  "+temp.getDate()+" "+temp.getTotalCases());
                records.add( temp);
            }
            columnCountry = new TableColumn<Record,String>();
            columnCases = new TableColumn<Record,Long>();
            columnCases1M = new TableColumn<Record,Double>();
            columnDeath = new TableColumn<Record,Long>();
            columnDeath1m = new TableColumn<Record,Double>();
            columnFully = new TableColumn<Record,Long>();
            columnfull1M = new TableColumn<Record,Double>();


            columnCountry.setText("Country");
            columnCases.setText("Total Cases");
            columnCases1M.setText("Cases per 1M");
            columnDeath.setText("Total Deaths");
            columnDeath1m.setText("Total Deaths (Per1M)");
            columnFully.setText("Fully vaccinated");
            columnfull1M.setText("Rate of vaccination");
            tableTA.setItems(records);
            columnCountry.setCellValueFactory(param -> new SimpleObjectProperty<>(param.getValue().getCountry()));
            columnCases.setCellValueFactory(param -> new SimpleObjectProperty<>(param.getValue().getTotalCases()));
            columnCases1M.setCellValueFactory(param -> new SimpleObjectProperty<>(param.getValue().getTotalCasesPerMillion()));
            columnDeath.setCellValueFactory(param -> new SimpleObjectProperty<>(param.getValue().getTotalDeaths()));
            columnDeath1m.setCellValueFactory(param -> new SimpleObjectProperty<>( param.getValue().getTotalDeathsPerMillion()));
            columnFully.setCellValueFactory(param -> new SimpleObjectProperty<>(param.getValue().getFullyVaccinated()));
            columnfull1M.setCellValueFactory(param -> new SimpleObjectProperty<>(param.getValue().getRateOfVaccination()));
            tableTA.getColumns().clear();
            if (choiceboxTA.getValue().equals("A")){
                TAtitle.setText("Number of Confirmed COVID-19 Cases as of "+datepickerTA.getValue().toString());
                tableTA.getColumns().addAll(columnCountry,columnCases,columnCases1M);
            }else if (choiceboxTA.getValue().equals("B")){
                TAtitle.setText("Number of Confirmed COVID-19 Deaths as of "+datepickerTA.getValue().toString());
                tableTA.getColumns().addAll(columnCountry,columnDeath,columnDeath1m);
            }else{
                TAtitle.setText("Rate of Vaccination against COVID-19 as of "+datepickerTA.getValue().toString());
                tableTA.getColumns().addAll(columnCountry,columnFully,columnfull1M);
            }
        }
    }

    public void opentabA2(Event event) throws Exception {
        //Fill the listview
        enddateCA.setValue(LocalDate.now());
        listCA.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);
        Countries.read("COVID_Dataset_v1.0.csv");
        for (String temp:Countries.getCountriesString()){
            listCA.getItems().add(temp);
        }
        choiceboxCA.getItems().clear();
        choiceboxCA.getItems().add("A");
        choiceboxCA.getItems().add("B");
        choiceboxCA.getItems().add("C");
        choiceboxCA.getSelectionModel().selectFirst();
        //Setup charts

    }

    public void generateCA(ActionEvent actionEvent) throws Exception {
        //Check if date is valid
        //Check if selected countries
        //Generate Chart
        //Check if date is valid
        //Check if selected countries
        ObservableList<String> selectedcountries;
        selectedcountries = listCA.getSelectionModel().getSelectedItems();
        if (selectedcountries.isEmpty()){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Please choose countries");
            errorAlert.showAndWait();
        }
        else if (    (startdateCA.getValue()==null) || (enddateCA.getValue()==null) ) {
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Date is empty");
            errorAlert.showAndWait();
        }
        else if (  startdateCA.getValue().isAfter(LocalDate.now())  || enddateCA.getValue().isAfter(LocalDate.now())  ){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Date is after today");
            errorAlert.showAndWait();
        }
        else if ( startdateCA.getValue().isBefore(LocalDate.of(2020,3,1))   ||  enddateCA.getValue().isBefore(LocalDate.of(2020,3,1)) ){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("Date is before 2020 - 03 - 01, No data exists");
            errorAlert.showAndWait();
        }else if (enddateCA.getValue().isBefore(startdateCA.getValue())){
            Alert errorAlert = new Alert(Alert.AlertType.ERROR);
            errorAlert.setHeaderText("Input not valid");
            errorAlert.setContentText("End date is before start date");
            errorAlert.showAndWait();
        }
        else{
            textAreaConsole.setText("");
            textAreaConsole.setText(textAreaConsole.getText()+"Start date is:"+startdateCA.getValue().toString());
            textAreaConsole.setText(textAreaConsole.getText()+"End date is:"+enddateCA.getValue().toString());
            textAreaConsole.setText(textAreaConsole.getText()+"Countries:"+selectedcountries);
            //Generate Chart
            chartCA.getData().clear();
            chartCA.setTitle("Cumulative Confirmed COVID-19 Cases (per 1M)");
                for (String country : selectedcountries){
                    Records temprecords = new Records("COVID_Dataset_v1.0.csv");
                    Vector<Record> tempvector =  temprecords.getRecords(Countries.toIsoCode(country));
                    XYChart.Series<String, Long> series = new XYChart.Series<String, Long>();
                    for (Record x : tempvector) {
                        if (Countries.toIsoCode(country).equals(x.getCountry())) {
                            //System.out.println(country);
                            if ((x.getDate().equals(startdateCA.getValue())||x.getDate().isAfter(startdateCA.getValue())) && (x.getDate().equals(enddateCA.getValue())||x.getDate().isBefore(enddateCA.getValue()) ))
                                if (choiceboxCA.getValue().equals("A")) {
                                    chartCA.setTitle("Cumulative Confirmed COVID-19 Cases (per 1M)");
                                    series.getData().add(new XYChart.Data<String, Long>(x.getDate().toString(), (long) x.getTotalCasesPerMillion()));
                                }else if (choiceboxCA.getValue().equals("B")){
                                    chartCA.setTitle("Cumulative Confirmed COVID-19 Deaths (per 1M)");
                                    series.getData().add(new XYChart.Data<String, Long>(x.getDate().toString(), (long) x.getTotalDeathsPerMillion()));
                                }else{
                                    chartCA.setTitle("Cumulative Rate of Vaccination against COVID-19");
                                    series.getData().add(new XYChart.Data<String, Long>(x.getDate().toString(), (long) x.getRateOfVaccination()));
                                }
                        }
                    }
                    series.setName(country);
                    chartCA.getData().add(series);
                }
        }





    }
}

